---
layout:  post
title:  《从Paxos到Zookeeper》读书笔记（二）--2PC与3PC
date: 2019-06-22 13:32:20 +0300
tags: [分布式,ZooKeeper,读书笔记]
typora-root-url: .
typora-copy-images-to: ..\assets\clipimg
---

# 第2章 一致性协议

 

## 2.1 2PC与3PC

在分布式系统中，一个机器节点虽然都能够明确地知道自己在进行事务操作过程中的结果是成功或失败，但却无法直接获取到其他分布式节点的操作结果。因此，当一个事务操作需要跨越多个分布式节点的时候，为了保持事务处理的ACID特性，就需要引人一个称为**“协调者(Coordinator)”**的组件来统一调度所有分布式节点的执行逻辑，这些被调度的分布式节点则被称为**“参与者”**（Participant)。协调者负责调度参与者的行为，并最终决定这些参与者是否要把事务真正进行提交。基于这个思想，衍生出了**二阶段提交**和**三阶段提交**两种协议，在本节中，我们将重点对这两种分布式事务中涉及的一致性协议进行讲解。

 

**2PC：**Two-Phase Commit，二阶段提交，一种一致性协议。先尝试后提交，强一致性的算法。

 

**阶段一（投票阶段）：提交事务请求**

1. 事务询问：协调者向所有的参与者发送事务内荣，询问是否可以执行事务提交操作，并开始等待各参与者的响应。
2. 执行事务：各参与者节点执行事务操作，并将Undo和Redo信息记入事务日志中。
3. 个参与者想协调者反馈事务询问的响应：如果参与者成功执行了事务操作，那么就反馈给协调者Yes响应，表示事务可以执行；如果参与者没有成功执行事务，那么就反馈给协调镇NO响应，表示事务不可以执行

 

**阶段二（执行）：执行事务提交**

 

**执行事务提交：**如果协调者从所有的参与者获得的反馈都是Yes响应，那么就会执行事务提交

1. 发送提交请求。协调者向所有参与者节点发出Commit请求
2. 事务提交。参与者接受到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源
3. 反馈事务提交结果。参与者在完成事务提交之后，向协调者发送Ack消息。

**中断事务：**假如任何一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务

1. 发送回滚请求。协调者向所有参与者节点发出Rollback请求
2. 事务回滚。参与者接收到Rollback请求后，会利用其在一阶段中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源。
3. 反馈事务回滚结果。参与者在完成事务回滚之后，向协调者发送A出口信息。
4. 中断事务。协调者接受到所有参与者反馈的Ack信息后，完成事务中断。

 

![二阶段示意图](/../assets/clipimg/clip_image001-1561528345127.png)

 

**优点：**原理简单，实现方便

**缺点：**同步阻塞，单点问题，脑裂，太过保守

 

**3PC：**Three-Phrase Commit，三阶段提交

![三阶段示意图](/../assets/clipimg/clip_image002-1561528357421.png)

**阶段一：CanCommit**

1. 事务询问。协调者向所有的参与者发送一个包含事务内荣的canCommit请求，询问是否可以执行事务提交操作，并开始等待各参与者的响应
2. 各参与者向协调者反馈事务询问的响应。参与者在接收到来自协调者的canCommit请求后，正常情况下，如果其自身认为可以顺利执行事务，那么会反馈Yes响应，并进入预备状态，否则反馈No响应

**阶段二：PreCommit**

**执行事务预提交**：如果所有的参与者都发送了Yes

1. 发送预提交请求。协调者向所有参与者节点发出preCommit的请求，并进入Prepared阶段
2. 事务预提交。参与者接收到preCommit请求后，会执行事务操作，并将Undo和Redo信息记录到事务日志中。
3. 各参与者向协调者反馈事务执行的响应。如果参与者成功执行了事务操作，那么就会反馈给协调者Ack响应，同时等待最终的指令：提交或终止

**中断事务**：有参与者发送了No响应或等待超时

1. 发送中断请求。协调者向所有参与者节点发出abort请求
2. 中断事务。无论是收到来自协调者的abort请求，或者是在等待协调者请求过程中出现超时，参与者都会中断事务

**阶段三：doCommit**

**执行提交：**协调者正常工作并接收到了来自所有参与者的Ack响应。

1. 发送提交请求。协调者向所有的参与者发送doCommit请求
2. 事务提交。参与者接收到doCommit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源
3. 反馈事务提交结果。参与者完成事务提交后向协调者发送Ack消息
4. 完成事务。协调者接受到所有参与者反馈的Ack消息后，完成事务

**中断事务：**协调者正常工作，并且受到No响应或是等待超时

1. 发送中断请求
2. 事务回滚
3. 反馈事务回滚结果
4. 中断事务

 

**可能出现的故障：**协调者出现问题、协调者和参与者之间的网络出现故障

 

**优点：**相对于二阶段提交，降低了参与者的阻塞范围，并且能够在出现单点故障后继续达成一致

**缺点：**如果网络出现分区，使协调者所在的节点和参与者无法进行正常的网络通信，会出现数据的不一致性。

 

## 2.2 Paxos算法

 

一种基于消息传递且具有高度容错特性的一致性算法。公认的解决分布式一致性问题最有效的算法之一。

